/*! MS Sharepoint Upload Form Loader  - v0.1 - 2013-09-26
* Original author : @nufaylr
* Licensed under the MIT license
*/
(function(e){e.fn.SPLoadUploadForm=function(t){var n=e.extend({libraryId:null,sitePath:"",frameWidth:450,frameHeight:130,styleClass:"formstyle",loadingGif:"loading.gif",buttonColor:"#CE473D",formBackground:"#FFF",overwrite:false,formComplete:null,uploadComplete:null,validate:null},t);var r={done:"success",error:"error",uploadDone:"success",uploadError:"error",settingsError:"Please check the API document. Missing some settings"};var i={bmp:"bmp",gif:"gif",jpg:"jpg",jpeg:"jpeg",jpe:"jpe",png:"png",psd:"psd",tga:"tga",tif:"tif",thm:"thm",tiff:"tiff",yuv:"yuv",doc:"doc",docx:"docx",pdf:"pdf",txt:"txt"};var s={status:undefined,fileName:undefined,fileType:undefined,image:{width:0,height:0}};var o="0px";var u="0px";var a=navigator.appName,f=navigator.userAgent,l;var c=f.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);if(c&&(l=f.match(/version\/([\.\d]+)/i))!=null)c[2]=l[1];c=c?[c[1],c[2]]:[a,navigator.appVersion,"-?"];if(c[0]!="MSIE"){o="0.4em";u="0.1em"}var h='<style type="text/css">'+".ms-descriptiontext{background : "+n.formBackground+";}"+"#MSO_ContentTable{background : "+n.formBackground+";}"+"#ctl00_PlaceHolderMain_UploadDocumentSection .ms-authoringcontrols{background : "+n.formBackground+";}"+".ms-sectionline{height : 1px;}"+"#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK{"+"background : "+n.buttonColor+";"+"border : solid 1px #eee;"+"color : #fff;"+"font-size : 13px;"+"width : 100px;"+"height : 26px;"+"padding : 0px;"+"padding-bottom : "+o+";"+"padding-top : "+u+";"+"margin : 0px 0px 0px 20px;"+"}"+"body{background-color : "+n.formBackground+";}"+".frameInsideMessage{padding-top : 25px;}"+"</style>";var p=this;var d="iframe_"+p.attr("id");if(n.libraryId!=null){if(c[0]=="MSIE"){var v=n.frameWidth+0;n.frameWidth=v}return p.each(function(){function E(t,u){if(t!=undefined&&u!=undefined){function f(){var e=new Date;var t=e.getMonth()+1;var n=e.getDate();var r=e.getFullYear();var i=e.getHours();var s=e.getMinutes();var o=e.getSeconds();var u=""+t+""+n+""+r+""+i+""+s+""+o+"";var a="?cimg="+u+"";return a}var l=u.split(".")[1].toLowerCase();var c="//"+window.location.host+""+t+"/"+u+""+f()+"";var h=o.contents();h.find("body").attr("onload"," ");h.find("body").empty();s.fileName=u;s.fileType=l;if(i[l]===l){var d=e("<img />").attr({id:"tempFileLoader",src:c});d.css({display:"none"});p.append(d);e("#tempFileLoader").load(function(){s.image.width=e(this).width();s.image.height=e(this).height()})}else{var v=e("<div />").attr({id:"tempFileLoader"});v.css({display:"none"});var g=setInterval(function(){v.load(c,function(e,t,n){if(t==="success"){clearInterval(g)}})},3e3)}m.text("Successfully Uploaded.");h.find("body").append(m);if(e.isFunction(n.uploadComplete)){s.status=r.uploadDone;n.uploadComplete.call(a,s)}}}var t=""+n.sitePath+"/_layouts/Upload.aspx?List="+n.libraryId+"&RootFolder=&IsDlg=1";var o=e("<iframe />").attr({width:n.frameWidth+"px",height:n.frameHeight+"px",scrolling:"no",frameborder:"0",src:t,id:d});var u=e("<div />").css({width:n.frameWidth+"px",height:n.frameHeight+"px",position:"relative",overflow:"hidden"});u.attr({"class":n.styleClass});var a=e("<div />");var f=e("<input />").attr({type:"hidden",id:"hiddenDestination"});var l=e("<input />").attr({type:"hidden",id:"hiddenFileName"});var v=e("<input />").attr({type:"hidden",id:"hiddenFormCount",value:1});var m=e("<h3 />").addClass("frameInsideMessage");var g=e("<p />").addClass("frameInsideDescription");a.append(o);u.append(a);p.append(u);p.append(v);var y=0;var b="blank";var w=false;o.load(function(){var i=o.contents();i.find("head").append(h);if(v.val()==1){w=true}else{y=1}if(i.find("#errorPageTitleSpan").text()!="Error"&&w!=false){i.find("#s4-workspace").attr("style"," ");i.find("#s4-workspace").css({"overflow-y":"auto"});i.find("#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK").val("Upload");i.find("#ctl00_PlaceHolderMain_UploadDocumentSection td").eq(0).remove();i.find("#ctl00_PlaceHolderMain_ctl03_BtnCancel").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_LiteralLabelText").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_UploadMultipleLink").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_tablerow1").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_tablerow5").remove();i.find("#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK").parent().prev().remove();if(n.overwrite==false){i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_OverwriteSingle").next().remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_OverwriteSingle").remove()}if(y==0){if(e.isFunction(n.formComplete)){n.formComplete.call(a,r.done)}}b=i.find("#destination").val();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_InputFile").change(function(){n.validate.call(a,e(this).val())});i.find("#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK").on("click",function(){f.attr("value",b);l.attr("value",i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_InputFile").val());e("#hiddenFormCount").val("0");p.append(f);p.append(l)});if(y==1){var s=e("#hiddenFileName").val().replace(/^.*[\\\/]/,"");if(c[0]=="MSIE"){s=e("#hiddenFileName").val().replace(/^.*[\\\/]/,"")}E(e("#hiddenDestination").val(),s)}}else{var u=i.find("#ctl00_PlaceHolderMain_LabelMessage").text();i.find("body").empty();m.text("Upload Error");g.text(u);i.find("body").append(m);i.find("body").append(g);if(y==0){if(e.isFunction(n.formComplete)){n.formComplete.call(a,r.error)}}if(y==1){if(e.isFunction(n.uploadComplete)){n.uploadComplete.call(a,r.uploadError)}var S=e("<a />").attr({id:"reloadFrame",href:"#"}).click(function(){y=0;w=false;e("#hiddenFormCount").val("1");e("#"+d+"").attr("src",t)});S.text("Upload different file.");i.find("body").append(S)}}})})}else{return p.each(function(){p.append(r.settingsError)})}}})(jQuery)
