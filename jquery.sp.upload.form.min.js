/*! MS Sharepoint Upload Form Loader  - v0.1 - 2013-09-26
* Original author : @nufaylr
* Licensed under the MIT license
*/
(function(e){e.fn.SPLoadUploadForm=function(t){var n=e.extend({libraryId:null,sitePath:"//"+window.location.host+_spPageContextInfo.webServerRelativeUrl,frameWidth:450,frameHeight:130,styleClass:"formstyle",loadingGif:"loading.gif",buttonColor:"#CE473D",formBackground:"#FFF",overwrite:false,formComplete:null,uploadComplete:null},t);var r={done:"success",error:"error",uploadDone:"success",uploadError:"error",settingsError:"Please check the API document. Missing some settings"};var i={bmp:"bmp",gif:"gif",jpg:"jpg",jpeg:"jpeg",jpe:"jpe",png:"png",psd:"psd",tga:"tga",tif:"tif",thm:"thm",tiff:"tiff",yuv:"yuv",doc:"doc",docx:"docx",pdf:"pdf",txt:"txt"};var s={status:undefined,fileName:undefined,fileType:undefined,image:{width:0,height:0}};var o="0px";var u="0px";if(!e.browser.msie){o="0.4em";u="0.1em"}var a='<style type="text/css">'+".ms-descriptiontext{background : "+n.formBackground+";}"+"#MSO_ContentTable{background : "+n.formBackground+";}"+"#ctl00_PlaceHolderMain_UploadDocumentSection .ms-authoringcontrols{background : "+n.formBackground+";}"+".ms-sectionline{height : 1px;}"+"#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK{"+"background : "+n.buttonColor+";"+"border : solid 1px #eee;"+"color : #fff;"+"font-size : 13px;"+"width : 100px;"+"height : 26px;"+"padding : 0px;"+"padding-bottom : "+o+";"+"padding-top : "+u+";"+"margin : 0px 0px 0px 20px;"+"}"+"body{background-color : "+n.formBackground+";}"+".frameInsideMessage{padding-top : 25px;}"+"</style>";var f=this;var l="iframe_"+f.attr("id");if(n.libraryId!=null){if(e.browser.msie){var c=n.frameWidth+0;n.frameWidth=c}return f.each(function(){function w(t,u){if(t!=undefined&&u!=undefined){var a=u.split(".")[1].toLowerCase();var l="//"+window.location.host+""+t+"/"+u+"";var h=o.contents();h.find("body").attr("onload"," ");h.find("body").empty();s.fileName=u;s.fileType=a;if(i[a]===a){var p=e("<img />").attr({id:"tempFileLoader",src:l});p.css({display:"none"});f.append(p);e("#tempFileLoader").load(function(){s.image.width=e(this).width();s.image.height=e(this).height()})}else{var d=e("<div />").attr({id:"tempFileLoader"});d.css({display:"none"});var m=setInterval(function(){d.load(l,function(e,t,n){if(t==="success"){clearInterval(m)}})},3e3)}v.text("Successfully Uploaded.");h.find("body").append(v);if(e.isFunction(n.uploadComplete)){s.status=r.uploadDone;n.uploadComplete.call(c,s)}}}var t=""+n.sitePath+"/_layouts/Upload.aspx?List="+n.libraryId+"&RootFolder=&IsDlg=1";var o=e("<iframe />").attr({width:n.frameWidth+"px",height:n.frameHeight+"px",scrolling:"no",frameborder:"0",src:t,id:l});var u=e("<div />").css({width:n.frameWidth+"px",height:n.frameHeight+"px",position:"relative",overflow:"hidden"});u.attr({"class":n.styleClass});var c=e("<div />");var h=e("<input />").attr({type:"hidden",id:"hiddenDestination"});var p=e("<input />").attr({type:"hidden",id:"hiddenFileName"});var d=e("<input />").attr({type:"hidden",id:"hiddenFormCount",value:1});var v=e("<h3 />").addClass("frameInsideMessage");var m=e("<p />").addClass("frameInsideDescription");c.append(o);u.append(c);f.append(u);f.append(d);var g=0;var y="blank";var b=false;o.load(function(){var i=o.contents();i.find("head").append(a);if(d.val()==1){b=true}else{g=1}if(i.find("#errorPageTitleSpan").text()!="Error"&&b!=false){i.find("#s4-workspace").attr("style"," ");i.find("#s4-workspace").css({"overflow-y":"auto"});i.find("#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK").val("Upload");i.find("#ctl00_PlaceHolderMain_UploadDocumentSection td").eq(0).remove();i.find("#ctl00_PlaceHolderMain_ctl03_BtnCancel").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_LiteralLabelText").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_UploadMultipleLink").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_tablerow1").remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_tablerow5").remove();i.find("#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK").parent().prev().remove();if(n.overwrite==false){i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_OverwriteSingle").next().remove();i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_OverwriteSingle").remove()}if(g==0){if(e.isFunction(n.formComplete)){n.formComplete.call(c,r.done)}}y=i.find("#destination").val();i.find("#ctl00_PlaceHolderMain_ctl03_RptControls_btnOK").on("click",function(){h.attr("value",y);p.attr("value",i.find("#ctl00_PlaceHolderMain_UploadDocumentSection_ctl03_InputFile").val());e("#hiddenFormCount").val("0");f.append(h);f.append(p)});if(g==1){w(e("#hiddenDestination").val(),e("#hiddenFileName").val())}}else{var s=i.find("#ctl00_PlaceHolderMain_LabelMessage").text();i.find("body").empty();v.text("Upload Error");m.text(s);i.find("body").append(v);i.find("body").append(m);if(g==0){if(e.isFunction(n.formComplete)){n.formComplete.call(c,r.error)}}if(g==1){if(e.isFunction(n.uploadComplete)){n.uploadComplete.call(c,r.uploadError)}var u=e("<a />").attr({id:"reloadFrame",href:"#"}).click(function(){g=0;b=false;e("#hiddenFormCount").val("1");e("#"+l+"").attr("src",t)});u.text("Upload different file.");i.find("body").append(u)}}})})}else{return f.each(function(){f.append(r.settingsError)})}}})(jQuery)